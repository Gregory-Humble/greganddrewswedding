<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Greg & Drew ‚Äî Wedding Invitation</title>
    <meta name="description" content="You're invited to celebrate Greg & Drew. RSVP online.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300..700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root { --accent: #0f172a; }
      .font-display { font-family: 'Fraunces', ui-serif, Georgia, serif; }
      .font-sans { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans'; }
    </style>
  </head>
  <body class="font-sans text-slate-800 bg-white">
    <noscript>
      <div class="mx-auto max-w-3xl m-4 p-4 border rounded-xl bg-amber-50">
        This site needs JavaScript enabled for RSVP and maps links.
      </div>
    </noscript>

    <!-- NAV -->
    <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/90 border-b border-slate-200">
      <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between">
        <span class="font-display tracking-wider text-xl">G ¬∑ D</span>
        <nav class="hidden md:flex gap-8 text-sm">
          <a href="#details" class="hover:text-slate-900">Details</a>
          <a href="#schedule" class="hover:text-slate-900">Schedule</a>
          <a href="#venue" class="hover:text-slate-900">Venue</a>
          <a href="#rsvp" class="hover:text-slate-900">RSVP</a>
        </nav>
        <a href="#rsvp" class="inline-flex items-center gap-2 text-sm font-medium bg-slate-900 text-white px-4 py-2 rounded-xl shadow-sm">RSVP</a>
      </div>
    </header>

    <!-- HERO -->
    <section class="relative overflow-hidden">
      <div class="absolute inset-0" aria-hidden>
        <div class="absolute -top-40 -right-32 w-[42rem] h-[42rem] rounded-full bg-[radial-gradient(closest-side,rgba(2,6,23,0.08),transparent)]"></div>
        <div class="absolute -bottom-32 -left-16 w-[32rem] h-[32rem] rounded-full bg-[radial-gradient(closest-side,rgba(2,6,23,0.06),transparent)]"></div>
      </div>
      <div class="mx-auto max-w-6xl px-6 py-24 md:py-32 relative">
        <p class="text-sm tracking-widest uppercase text-slate-600">You are invited to celebrate</p>
        <h1 class="font-display text-5xl md:text-7xl mt-3 leading-tight">Greg & Drew</h1>
        <p class="mt-5 text-lg text-slate-700" data-date-time>Friday, 13 February ¬∑ Ceremony 3:00 pm</p>
        <p class="mt-1 text-slate-700 flex items-center gap-2">
          <span>üìç</span> <span data-venue>Old Treasury Building, Melbourne</span>
        </p>
        <div class="mt-8 flex flex-wrap gap-3">
          <a href="#details" class="px-5 py-3 rounded-xl border border-slate-300 hover:border-slate-400">Event details</a>
          <a href="#rsvp" class="px-5 py-3 rounded-xl bg-slate-900 text-white">RSVP now</a>
        </div>
      </div>
    </section>

    <!-- DETAILS -->
    <section id="details" class="mx-auto max-w-6xl px-6 py-16 md:py-24">
      <div class="mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Plan</p>
        <h2 class="font-display text-3xl md:text-4xl mt-2">The Details</h2>
      </div>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="rounded-2xl border border-slate-200 p-6 bg-white info-card">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">RSVP by</p>
          <p class="mt-2 text-slate-800 leading-relaxed" data-rsvpby>‚Äî</p>
        </div>
        <div class="rounded-2xl border border-slate-200 p-6 bg-white">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Dress code</p>
          <p class="mt-2 text-slate-800 leading-relaxed" data-dress></p>
        </div>
        <div class="rounded-2xl border border-slate-200 p-6 bg-white">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Notes</p>
          <p class="mt-2 text-slate-800 leading-relaxed" data-notes></p>
        </div>
      </div>
    </section>

    <!-- SCHEDULE -->
    <section id="schedule" class="mx-auto max-w-6xl px-6 py-16 md:py-24">
      <div class="mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Order of the day</p>
        <h2 class="font-display text-3xl md:text-4xl mt-2">Schedule</h2>
      </div>
      <ul class="grid md:grid-cols-2 gap-4">
        <li class="rounded-2xl border border-slate-200 p-5">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">3:00 pm</p>
          <p class="mt-1 text-lg">Ceremony at the Old Treasury Building</p>
        </li>
        <li class="rounded-2xl border border-slate-200 p-5">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">6:00 pm ‚Äì 9:30 pm</p>
          <p class="mt-1 text-lg">Dinner at Reed House</p>
        </li>
      </ul>
    </section>

    <!-- VENUE -->
    <section id="venue" class="mx-auto max-w-6xl px-6 py-16 md:py-24">
      <div class="mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Where to go</p>
        <h2 class="font-display text-3xl md:text-4xl mt-2">Venues</h2>
      </div>
      <div class="grid lg:grid-cols-2 gap-8 items-start">
        <div class="rounded-2xl border border-slate-200 p-6">
          <h3 class="text-xl font-medium">Old Treasury Building</h3>
          <p class="mt-1 text-slate-700">Margaret Craig Room ¬∑ 20 Spring St, Melbourne VIC</p>
          <!-- href is set/confirmed by JS; give a harmless default so it's still clickable -->
          <a
            href="https://www.google.com/maps?q=20%20Spring%20St%2C%20Melbourne%20VIC"
            data-venue-map
            data-address="20 Spring St, Melbourne VIC"
            target="_blank"
            rel="noreferrer"
            class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 hover:border-slate-400"
          >
            Open in Maps
          </a>
          <p class="mt-6 text-sm text-slate-600">Please arrive 10‚Äì15 minutes early. The ceremony will begin at 4:00 pm.</p>
        </div>
        <div class="rounded-2xl border border-slate-200 p-6">
          <h3 class="text-xl font-medium" data-dinner-name>Dinner at Reed House</h3>
          <p class="mt-1 text-slate-700" data-dinner-address>130 Lonsdale St, Melbourne VIC</p>
          <p class="mt-1 text-slate-700" data-dinner-time>6:00 pm ‚Äì 9:30 pm</p>
          <a
            href="https://www.google.com/maps?q=130%20Lonsdale%20St%2C%20Melbourne%20VIC"
            data-dinner-map
            data-address="130 Lonsdale St, Melbourne VIC"
            target="_blank"
            rel="noreferrer"
            class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 hover:border-slate-400"
          >
            Open in Maps
          </a>
        </div>
      </div>
    </section>

    <!-- RSVP -->
    <section id="rsvp" class="mx-auto max-w-6xl px-6 py-16 md:py-24">
      <div class="mb-10">
        <p class="text-xs uppercase tracking-[0.2em] text-slate-500">We'd love to celebrate with you</p>
        <h2 class="font-display text-3xl md:text-4xl mt-2">RSVP</h2>
      </div>

      <!-- Invite code gate -->
      <div id="invite-gate" class="hidden rounded-2xl border border-slate-200 p-6 bg-white max-w-xl">
        <p class="text-slate-700 mb-3">Please enter your invite code (found on your invitation):</p>
        <div class="flex gap-3">
          <input id="invite-code-input" class="w-48 rounded-xl border border-slate-300 bg-white px-4 py-2 outline-none focus:ring-2 focus:ring-slate-300 uppercase" placeholder="e.g. R7K4" maxlength="12">
          <button id="invite-code-continue" class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-xl">Continue</button>
        </div>
        <p id="invite-code-error" class="mt-3 text-sm text-rose-600 hidden">That code wasn‚Äôt recognised. Please check and try again.</p>
      </div>

      <form id="rsvp-form" class="grid lg:grid-cols-2 gap-8">
        <!-- Column 1 -->
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
              <span class="block mb-2 text-sm font-medium text-slate-700">Your first name *</span>
              <input name="firstName" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300">
            </label>
            <label class="block">
              <span class="block mb-2 text-sm font-medium text-slate-700">Your last name *</span>
              <input name="lastName" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300">
            </label>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
              <span class="block mb-2 text-sm font-medium text-slate-700">Email *</span>
              <input type="email" name="email" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300">
            </label>
            <label class="block">
              <span class="block mb-2 text-sm font-medium text-slate-700">Phone</span>
              <input name="phone" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300">
            </label>
          </div>

          <!-- Party size -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label class="block">
              <span id="party-label" class="block mb-1 text-sm font-medium text-slate-700">How many people attending (including you)?</span>
              <input type="number" id="party-size" name="partySize" min="1" max="10" value="1" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300">
              <span id="party-hint" class="block mt-1 text-xs text-slate-500"></span>
            </label>
            <div class="hidden md:block"></div>
          </div>

          <!-- Ceremony RSVP -->
          <label class="block">
            <span class="block mb-2 text-sm font-medium text-slate-700">Will your party attend the ceremony?</span>
            <div id="attending-ceremony" class="flex gap-4 flex-wrap">
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer bg-slate-900 text-white border-slate-900" data-attend-ceremony="yes">
                <input type="radio" name="attendingCeremony" value="yes" class="sr-only" checked>
                Joyfully accepts
              </label>
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer" data-attend-ceremony="no">
                <input type="radio" name="attendingCeremony" value="no" class="sr-only">
                Regretfully declines
              </label>
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer" data-attend-ceremony="unsure">
                <input type="radio" name="attendingCeremony" value="unsure" class="sr-only">
                Unsure (TBC)
              </label>
            </div>
          </label>

          <!-- Dinner RSVP -->
          <label class="block">
            <span class="block mb-2 text-sm font-medium text-slate-700">Will your party attend the dinner?</span>
            <div id="attending-dinner" class="flex gap-4 flex-wrap">
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer bg-slate-900 text-white border-slate-900" data-attend-dinner="yes">
                <input type="radio" name="attendingDinner" value="yes" class="sr-only" checked>
                Yes, we'll be there
              </label>
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer" data-attend-dinner="no">
                <input type="radio" name="attendingDinner" value="no" class="sr-only">
                Sorry, can't make dinner
              </label>
              <label class="inline-flex items-center px-4 py-2 rounded-xl border border-slate-300 text-slate-700 cursor-pointer" data-attend-dinner="unsure">
                <input type="radio" name="attendingDinner" value="unsure" class="sr-only">
                Unsure (TBC)
              </label>
            </div>
          </label>
        </div>

        <!-- Column 2 -->
        <div class="space-y-6">
          <div>
            <span class="block mb-2 text-sm font-medium text-slate-700">Guest details (names & dietaries)</span>
            <div id="guest-list" class="space-y-4"></div>
          </div>

          <label class="block">
            <span class="block mb-2 text-sm font-medium text-slate-700">Message (optional)</span>
            <textarea rows="5" name="note" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300" placeholder="Anything we should know ‚Äì accessibility, kids, timing, etc."></textarea>
          </label>

          <div class="flex flex-wrap items-center gap-3">
            <button id="submit-btn" type="submit" class="inline-flex items-center gap-2 bg-slate-900 text-white px-5 py-3 rounded-xl shadow-sm hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed">Submit RSVP</button>
            <a href="#" class="inline-flex items-center gap-2 border border-slate-300 hover:border-slate-400 px-4 py-2 rounded-xl" onclick="window.scrollTo({top:0, behavior:'smooth'})">Back to top</a>
          </div>
          <p class="text-xs text-slate-500">Your details are kept private and used only for wedding planning.</p>
        </div>
      </form>
    </section>

    <footer class="mt-24 py-10 text-center text-sm text-slate-500">Crafted with ‚ô• for Greg & Drew</footer>

    <!-- Config first -->
    <script src="./assets/config.js"></script>
    <script src="./assets/invites.js"></script>
    <script src="./assets/script.js"></script>

    <!-- Main logic -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const cfg = window.SITE_CONFIG || {};
        const INVITES = window.INVITES || {}; // fine if missing/empty
        const CONTACT_EMAIL = cfg.contactEmail || "gregory.r.humble@hotmail.com";
        const FORMSPREE = cfg.formspreeEndpoint || "";

        /* ---------- 1) Fix/ensure Maps links ---------- */
        function mapHrefFrom(address) {
          return "https://www.google.com/maps?q=" + encodeURIComponent(address);
        }
        const venueMapEl  = document.querySelector("[data-venue-map]");
        const dinnerMapEl = document.querySelector("[data-dinner-map]");

        const ceremonyHref = cfg.event?.mapsUrl || (cfg.event?.venueAddress ? mapHrefFrom(cfg.event.venueAddress) : "#");
        const dinnerHref   = (cfg.event?.dinner?.mapsUrl) || (cfg.event?.dinner?.address ? mapHrefFrom(cfg.event.dinner.address) : "#");

        if (venueMapEl) {
          venueMapEl.href = ceremonyHref;
          if (ceremonyHref === "#") { venueMapEl.classList.add("opacity-50","pointer-events-none"); venueMapEl.title="Map link not available"; }
        }
        if (dinnerMapEl) {
          dinnerMapEl.href = dinnerHref;
          if (dinnerHref === "#") { dinnerMapEl.classList.add("opacity-50","pointer-events-none"); dinnerMapEl.title="Map link not available"; }
        }

        /* ---------- 2) Invite code & party size ---------- */
        const form = document.getElementById("rsvp-form");
        const gate = document.getElementById("invite-gate");
        const codeInput = document.getElementById("invite-code-input");
        const codeBtn   = document.getElementById("invite-code-continue");
        const codeErr   = document.getElementById("invite-code-error");
        const partyInput = document.getElementById("party-size");
        const partyHint  = document.getElementById("party-hint");
        const guestList  = document.getElementById("guest-list");

        function getParam(name){ return new URLSearchParams(window.location.search).get(name); }
        function normalizeCode(c){ return (c||"").trim().toUpperCase(); }

        // globals to reuse after submit
        let CURRENT_INVITE = null;
        let CURRENT_DEFAULT_COUNT = 1;

        // Build per-guest cards
        const DIETARY = ["Vegetarian","Vegan","Gluten free","Dairy free","Nut allergy","No seafood","Halal"];
        function guestCard(index, name="") {
          const n = index + 1;
          return `
            <div class="rounded-2xl border border-slate-200 p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="block">
                  <span class="block mb-2 text-sm font-medium text-slate-700">Guest ${n} name ${n===1 ? "(you) *" : "*"}</span>
                  <input name="guestName_${index}" value="${name.replace(/"/g,'&quot;')}" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300" placeholder="${n===1 ? 'Your full name' : 'Full name'}">
                </label>
                <div></div>
              </div>
              <div class="mt-3">
                <span class="block mb-2 text-sm font-medium text-slate-700">Guest ${n} dietary requirements</span>
                <div class="grid grid-cols-2 gap-3">
                  ${DIETARY.map(d => `
                    <label class="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-3 py-2 text-sm text-slate-700 cursor-pointer">
                      <input type="checkbox" name="guestDiet_${index}" value="${d}" class="sr-only"><span>‚úî</span><span>${d}</span>
                    </label>
                  `).join("")}
                  <input class="w-full rounded-xl border border-slate-300 bg-white px-4 py-2.5 outline-none focus:ring-2 focus:ring-slate-300 col-span-2" name="guestDietOther_${index}" placeholder="Other (please specify)">
                </div>
              </div>
            </div>
          `;
        }
        function wireDietaryHighlights() {
          document.querySelectorAll("input[type='checkbox'][name^='guestDiet_']").forEach(input => {
            const label = input.closest("label");
            if (!label) return;
            function updateLabel(){ label.classList.toggle("bg-slate-900", input.checked); label.classList.toggle("text-white", input.checked); label.classList.toggle("border-slate-900", input.checked); }
            label.addEventListener("click", () => setTimeout(updateLabel, 0));
            input.addEventListener("change", updateLabel);
            updateLabel();
          });
        }
        function renderGuests(count, defaults=[]) {
          const size = Math.max(1, Math.min(10, parseInt(count || "1", 10)));
          guestList.innerHTML = Array.from({length: size}).map((_, i) => guestCard(i, defaults[i] || "")).join("");
          wireDietaryHighlights();
        }

        // UPDATED: pre-fill party size to defaultNames.length (if provided) else maxGuests
        function applyInvite(inv) {
          CURRENT_INVITE = inv || null;

          const max = inv?.maxGuests ?? 10;
          const defaults = Array.isArray(inv?.defaultNames) ? inv.defaultNames : [];
          const defaultCount = Math.max(1, Math.min(defaults.length || max, max));
          CURRENT_DEFAULT_COUNT = defaultCount;

          partyInput.max = String(max);
          partyInput.value = String(defaultCount);
          partyHint.textContent = inv ? `Your invitation allows up to ${max} guest${max>1?"s":""}.` : "";

          renderGuests(defaultCount, defaults);
        }

        function showGate() {
          form.classList.add("hidden");
          gate.classList.remove("hidden");
          codeErr.classList.add("hidden");
          codeBtn.onclick = () => {
            const entered = normalizeCode(codeInput.value);
            const inv = (INVITES && INVITES[entered]) ? INVITES[entered] : null;
            if (!inv) { codeErr.classList.remove("hidden"); return; }
            const url = new URL(window.location.href); url.searchParams.set("code", entered);
            window.history.replaceState({}, "", url.toString());
            gate.classList.add("hidden"); form.classList.remove("hidden");
            applyInvite(inv);
          };
        }

        // Decide if we gate or not
        const hasInviteTable = INVITES && Object.keys(INVITES).length > 0;
        const urlCode = normalizeCode(getParam("code"));
        if (hasInviteTable) {
          if (urlCode && INVITES[urlCode]) {
            applyInvite(INVITES[urlCode]);
          } else {
            showGate();
          }
        } else {
          // No invites.js present ‚Äî let the form work with a gentle default
          applyInvite(null);
        }

        // Keep party size within cap and re-render guest cards
        partyInput.addEventListener("input", () => {
          const max = parseInt(partyInput.max, 10) || 10;
          let val = parseInt(partyInput.value || "1", 10);
          if (isNaN(val) || val < 1) val = 1;
          if (val > max) val = max;
          partyInput.value = String(val);

          const defaults = (hasInviteTable && urlCode && INVITES[urlCode]?.defaultNames) ? INVITES[urlCode].defaultNames : [];
          renderGuests(val, defaults);
        });

        // Pill toggles for ceremony/dinner
        function wirePillGroup(selector, attr) {
          const group = document.querySelector(selector);
          if (!group) return;
          const labels = Array.from(group.querySelectorAll(`label[${attr}]`));
          function setActive(l) {
            labels.forEach(el => el.classList.remove("bg-slate-900","text-white","border-slate-900"));
            l.classList.add("bg-slate-900","text-white","border-slate-900");
            const input = l.querySelector("input[type='radio']"); if (input) input.checked = true;
          }
          labels.forEach(l => l.addEventListener("click", () => setActive(l)));
        }
        wirePillGroup("#attending-ceremony","data-attend-ceremony");
        wirePillGroup("#attending-dinner","data-attend-dinner");

        /* ---------- 3) Submit ---------- */
        form.addEventListener("submit", async function (e) {
          e.preventDefault();

          const fd = new FormData(form);
          const first = (fd.get("firstName") || "").toString().trim();
          const last  = (fd.get("lastName")  || "").toString().trim();
          const email = (fd.get("email")     || "").toString().trim();
          if (!first || !last || !email) { alert("Please complete your first name, last name, and email."); return; }

          const hasTable = INVITES && Object.keys(INVITES).length > 0;
          const code = normalizeCode(getParam("code"));
          const inv  = (hasTable && INVITES[code]) ? INVITES[code] : null;

          const phone  = (fd.get("phone") || "").toString().trim();
          const partySize = Math.max(1, Math.min(parseInt(document.getElementById("party-size").value || "1", 10), inv?.maxGuests ?? 10));
          const attendingCeremony = (fd.get("attendingCeremony") || "yes").toString();
          const attendingDinner   = (fd.get("attendingDinner")   || "yes").toString();
          const note   = (fd.get("note") || "").toString().trim();

          const guests = [];
          for (let i = 0; i < partySize; i++) {
            const name = (fd.get(`guestName_${i}`) || "").toString().trim();
            if (!name) { alert(`Please enter a name for Guest ${i+1}.`); return; }
            const diets = fd.getAll(`guestDiet_${i}`).map(String);
            const other = (fd.get(`guestDietOther_${i}`) || "").toString().trim();
            const dietarySummary = [...diets, other ? `Other: ${other}` : null].filter(Boolean).join("; ");
            guests.push({ index: i+1, name, dietary: diets, dietaryOther: other, dietarySummary });
          }

          const payload = {
            invite: inv ? { code, household: inv.household, maxGuests: inv.maxGuests } : null,
            contact: { firstName: first, lastName: last, email, phone },
            partySize,
            attending: { ceremony: attendingCeremony, dinner: attendingDinner },
            guests,
            note,
            couple: "Greg & Drew",
            event: {
              dateLong: cfg.event?.dateLong || "Friday, 13 February",
              time: cfg.event?.time || "3:00 pm",
              venueName: cfg.event?.venueName || "Old Treasury Building ‚Äì Margaret Craig Room",
              venueAddress: cfg.event?.venueAddress || "20 Spring St, Melbourne VIC"
            },
            timestamp: new Date().toISOString()
          };

          if (FORMSPREE) {
            try {
              const res = await fetch(FORMSPREE, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload)
              });
              if (!res.ok) throw new Error("Formspree error " + res.status);
              alert("Thank you! Your RSVP was submitted.");
              form.reset();

              // After reset, re-seed the party size to the invite‚Äôs default
              const invAfter = CURRENT_INVITE;
              const maxAfter = invAfter?.maxGuests ?? 10;
              const defaultsAfter = Array.isArray(invAfter?.defaultNames) ? invAfter.defaultNames : [];
              const defaultCountAfter = Math.max(1, Math.min(defaultsAfter.length || maxAfter, maxAfter));
              partyInput.max = String(maxAfter);
              partyInput.value = String(defaultCountAfter);
              renderGuests(defaultCountAfter, defaultsAfter);
              return;
            } catch (err) {
              console.error(err);
              alert("We couldn't reach the RSVP service. We'll open an email instead.");
            }
          }

          // Mailto fallback
          const subject = encodeURIComponent("RSVP ‚Äî Greg & Drew");
          const lines = [];
          if (inv) lines.push(`Invite code: ${code} (${inv.household})`);
          lines.push(`Contact: ${first} ${last}`);
          lines.push(`Email: ${email}`);
          if (phone) lines.push(`Phone: ${phone}`);
          lines.push(`Party size (attending): ${partySize}${inv ? " / max " + inv.maxGuests : ""}`);
          lines.push(`Ceremony: ${attendingCeremony}`);
          lines.push(`Dinner: ${attendingDinner}`);
          lines.push("");
          lines.push("Guests & dietaries:");
          guests.forEach(g => { lines.push(`  ‚Ä¢ ${g.name}${g.dietarySummary ? " ‚Äî " + g.dietarySummary : ""}`); });
          if (note) { lines.push(""); lines.push("Note:"); lines.push(note); }
          const body = encodeURIComponent(lines.join("\n"));
          window.location.href = `mailto:${CONTACT_EMAIL}?subject=${subject}&body=${body}`;
        });
      });
    </script>
  </body>
</html>
